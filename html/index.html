<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autopulse</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/nav.css">
    <link rel="stylesheet" href="/css/header.css">
    <script src="https://kit.fontawesome.com/dad89e78ab.js" crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <div class="nav-buttons">
            <span>Inicio</span>
        </div>
        <i class="fa-solid fa-question-circle" onclick="preguntar()"></i>
    </header>
    <div class="container" id="autos-container">
        <!-- Los autos se cargarán aquí dinámicamente -->
    </div>
    <nav>
        <i class="fa-solid fa-house casita" onclick="princi()" title="Inicio"></i>
        <i class="fa-solid fa-bell" onclick="verNotificaciones()" title="Notificaciones"></i>
        <i class="fa-solid fa-location-dot" onclick="ubicar()" title="Ubicaciones"></i>
        <h1 class="nombre">Autopulse</h1>
        <i class="fa-solid fa-gears config" onclick="registrar()" title="Registrar Auto"></i>
        <i class="fa-solid fa-wrench" onclick="agregarServicio()" title="Agregar Servicio"></i>
        <i class="fa-solid fa-right-from-bracket" onclick="cerrarSesion()" title="Cerrar sesión"></i>
    </nav>

    <script src="/script.js"></script>

    <script>
        // Confirmación para cerrar sesión
        function cerrarSesion() {
            const confirmacion = confirm("¿Estás seguro de que deseas cerrar sesión?");
            if (!confirmacion) return;

            if ('caches' in window) {
                caches.keys().then(function (names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                }).catch(err => {
                    console.error("Error al limpiar cachés:", err);
                });
            }

            document.cookie.split(";").forEach(cookie => {
                const eqPos = cookie.indexOf("=");
                const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;";
            });
            localStorage.clear();
            sessionStorage.clear();

            alert("Has cerrado sesión exitosamente.");
            window.location.href = 'inicio.html';
        }

        async function obtenerAutos() {
            const userId = localStorage.getItem("userid");
            if (!userId) {
                alert("No se encontró un User ID. Por favor, inicia sesión.");
                return;
            }
            try {
                const response = await fetch(`https://backend-autoplus.onrender.com/users/${userId}/vehicles/`);
                if (!response.ok) {
                    throw new Error('Error en la red');
                }
                const autos = await response.json();
                mostrarAutos(autos);
            } catch (error) {
                console.error('Error al obtener los autos:', error);
            }
        }

        function mostrarAutos(autos) {
            const container = document.getElementById('autos-container');
            container.innerHTML = '';
            autos.forEach(auto => {
                const div = document.createElement('div');
                div.className = 'tarjetaCarro';
                div.onclick = () => redirigir();
                div.innerHTML = `
                    <div class="fotoCarro">
                        <h2>${auto.make}</h2>
                        <img src="${auto.imageUrl}" alt="Vehículo" onerror="this.onerror=null; this.src='images/default-car.png';">
                    </div>
                    <div class="infoCarro">
                        <p><strong>Modelo:</strong> ${auto.model}</p>
                        <p><strong>Año:</strong> ${auto.year}</p>
                        <p><strong>Condición:</strong> <span class="${getStatusClass(auto.condition)}">${auto.condition}</span></p>
                        <p><strong>Kilometraje:</strong> ${auto.mileage}</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function getStatusClass(condition) {
            switch (condition) {
                case 'Bueno':
                    return 'statusBueno';
                case 'Promedio':
                    return 'statusPromedio';
                case 'Mala':
                    return 'statusMala';
                default:
                    return '';
            }
        }

        window.onload = obtenerAutos;
    </script>
</body>
</html>
