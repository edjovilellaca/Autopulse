<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Modificación - Autopulse</title>
    <link rel="stylesheet" href="css/style3.css">
    <link rel="stylesheet" href="css/nav.css">
    <link rel="stylesheet" href="css/header.css">
    <script src="https://kit.fontawesome.com/dad89e78ab.js" crossorigin="anonymous"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const userid = localStorage.getItem("userid");
            const userIdDisplay = document.getElementById("userIdDisplay");
            if (userid) {
                userIdDisplay.textContent = `User   ID: ${userid}`;
            } else {
                userIdDisplay.textContent = "No se encontró un User ID. Por favor, inicia sesión.";
            }

            const userId = localStorage.getItem("userid");
            if (!userId) {
                alert("Error: No se encontró el User ID. Por favor, inicia sesión.");
                return;
            }

            async function loadVehicles() {
                try {
                    const response = await fetch(`https://backend-autoplus.onrender.com/users/${userId}/vehicles`);
                    if (!response.ok) throw new Error("Error al obtener los vehículos.");

                    const vehicles = await response.json();
                    console.log("Vehículos cargados:", vehicles);

                    const vehicleSelect = document.getElementById("vehicleSelect");
                    vehicleSelect.innerHTML = `<option value="" disabled selected>Selecciona un vehículo</option>`;

                    if (vehicles.length > 0) {
                        localStorage.setItem("vehicleId", vehicles[0].vehicleId);
                    }

                    vehicles.forEach(vehicle => {
                        const option = document.createElement("option");
                        option.value = vehicle.vehicleId;
                        option.textContent = `${vehicle.make} ${vehicle.model} (${vehicle.vin})`;
                        vehicleSelect.appendChild(option);
                        console.log(`Opción añadida: ${vehicle.vehicleId} - ${vehicle.make} ${vehicle.model}`);
                    });

                    vehicleSelect.addEventListener("change", () => {
                        const vehicleId = vehicleSelect.value;
                        localStorage.setItem("vehicleId", vehicleId);
                    });
                } catch (error) {
                    console.error("Error al cargar los vehículos:", error.message);
                    alert("No se pudieron cargar los vehículos. Intenta más tarde.");
                }
            }

            loadVehicles();
        });

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("modificationForm").addEventListener("submit", async (event) => {
                event.preventDefault();

                const formData = new FormData();
                const userId = localStorage.getItem("userid");
                if (!userId) {
                    alert("Error: No se encontró el User ID. Por favor, inicia sesión.");
                    return;
                }

                const vehicleSelect = document.getElementById("vehicleSelect");
                const vehicleId = vehicleSelect.value;
                if (!vehicleId) {
                    alert("Error: Debes seleccionar un vehículo.");
                    return;
                }

                const modificationDateInput = document.getElementById("modificationDate");
                const modificationDate = modificationDateInput.value;
                if (!modificationDate) {
                    alert("Error: Debes ingresar una fecha.");
                    return;
                }

                const datePattern = /^(20[0-9]{2})-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/;
                if (!datePattern.test(modificationDate)) {
                    alert("Error: La fecha debe estar en el formato AAAA-MM-DD (por ejemplo, 2024-10-09).");
                    return;
                }

                const modificationTypeInput = document.getElementById("modificationType");
                const modificationType = modificationTypeInput.value.trim();

                const mileageInput = document.getElementById("mileageAtModification");
                const mileageAtModification = mileageInput.value.trim();

                const costInput = document.getElementById("cost");
                const cost = costInput.value.trim();

                const serviceCenterInput = document.getElementById("serviceCenter");
                const serviceCenter = serviceCenterInput.value.trim();

                const notesInput = document.getElementById("notes");
                const notes = notesInput.value.trim();

                const performedByInput = document.getElementById("performedBy");
                const performedBy = performedByInput.value.trim();

                const descriptionInput = document.getElementById("description");
                const description = descriptionInput.value.trim();

                if (!modificationType || !mileageAtModification || !cost || !serviceCenter || !notes || !performedBy || !description) {
                    alert("Error: Todos los campos son obligatorios.");
                    return;
                }

                formData.set("modificationDate", modificationDate);
                formData.set("modificationType", modificationType);
                formData.set("mileageAtModification", mileageAtModification);
                formData.set("cost", cost);
                formData.set("serviceCenter", serviceCenter);
                formData.set("notes", notes);
                formData.set("performedBy", performedBy);
                formData.set("description", description);

                const dataFormModification = {
                    modificationDate,
                    modificationType,
                    mileageAtModification,
                    cost,
                    serviceCenter,
                    notes,
                    performedBy,
                    description
                }

                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }
                console.log("Datos enviados a Firestore:", dataFormModification);

                const endpoint = `https://backend-autoplus.onrender.com/users/${userId}/vehicles/${vehicleId}/vehicleModifications`;

                try {
                    const response = await fetch(endpoint, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(dataFormModification),
                    });

                    if (response.ok) {
                        alert("Modificación agregada");
                        window.location.href = "index.html";
                    } else {
                        const result = await response.json();
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    alert(`Error de red: ${error.message}`);
                }
            });
        });
    </script>
</head>
<body>
    <header>
        <div class="nav-buttons">
            <button onclick="princi()" style="all: unset; cursor: pointer;">
                <span>Inicio</span>
            </button>
        </div>
        <i class="fa-solid fa-question-circle" onclick="preguntar()"></i>
    </header>
    
    <div class="divAgregar">
        <p id="userIdDisplay" style="margin-bottom: 20px; font-weight: bold; color: white;">User    ID: </p>
    
        <form id="modificationForm">
            <div class="info" id="vehiculo">
                <select class="input" id="vehicleSelect" name="vehicleSelect" required>
                    <option value="" disabled selected>Selecciona un vehículo</option>
                </select>
                <label class="label">Vehículo</label>
            </div>
            
            <div class="info" id="costo">
                <input type="number" step="0.01" class="input" id="cost" name="cost" required autocomplete="off">
                <label class="label">Costo</label>
            </div>
    
            <div class="info" id="millas">
                <input type="number" class="input" id="mileageAtModification" name="mileageAtModification" required autocomplete="off">
                <label class="label">Millas en la modificación</label>
            </div>
            
            <div class="info" id="notas">
                <textarea class="input textarea" id="notes" name="notes" rows="3" placeholder=" " required></textarea>
                <label class="label" for="notes">Notas</label>
            </div>
            
            <div class="info" id="centroServicio">
                <input type="text" class="input" id="serviceCenter" name="serviceCenter" required autocomplete="off">
                <label class="label">Centro de servicio</label>
            </div>
    
            <div class="info" id="fecha">
                <input type="text" class="input" id="modificationDate" name="modificationDate" required autocomplete="off" placeholder="AAAA-MM-DD">
                <label class="label">Fecha de la modificación</label>
            </div>
            
            <div class="info" id="tipoModificacion">
                <input type="text" class="input" id="modificationType" name="modificationType" required autocomplete="off">
                <label class="label">Tipo de modificación</label>
            </div>

            <div class="info" id="realizadoPor">
                <input type="text" class="input" id="performedBy" name="performedBy" required autocomplete="off">
                <label class="label">Realizado por</label>
            </div>

            <div class="info" id="descripcion">
                <textarea class="input textarea" id="description" name="description" rows="3" placeholder=" " required></textarea>
                <label class="label" for="description">Descripción</label>
            </div>
            
            <button type="submit" class="btn">Guardar Modificación</button>
        </form>
    </div>
    
    <nav>
        <i class="fa-solid fa-bell casita" onclick="verNotificaciones()"></i>
        <i class="fa-solid fa-location-dot casita" onclick="ubicar()"></i>
        <i class="fa-solid fa-house casita2" onclick="princi()"></i>
        <i class="fa-solid fa-gears config" onclick="registrar()"></i>
        <i class="fa-solid fa-wrench casita" onclick="agregarServicio()" title="Agregar Modificación"></i>
    </nav>

    <p id="response"></p>

  

</body>
</html>
<script src="script.js"></script>
<script src="https://kit.fontawesome.com/dad89e78ab.js" crossorigin="anonymous"></script>