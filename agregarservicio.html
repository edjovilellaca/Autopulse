<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Servicio - Autopulse</title>
    <link rel="stylesheet" href="css/style3.css">
    <link rel="stylesheet" href="css/nav.css">
    <link rel="stylesheet" href="css/header.css">
    <script src="https://kit.fontawesome.com/dad89e78ab.js" crossorigin="anonymous"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const userid = localStorage.getItem("userid");
            const userIdDisplay = document.getElementById("userIdDisplay");
            if (userid) {
                userIdDisplay.textContent = `User    ID: ${userid}`;
            } else {
                userIdDisplay.textContent = "No se encontró un User ID. Por favor, inicia sesión.";
            }

            const userId = localStorage.getItem("userid");
            if (!userId) {
                alert("Error: No se encontró el User ID. Por favor, inicia sesión.");
                return;
            }

            async function loadVehicles() {
                try {
                    const response = await fetch(`https://backend-autoplus.onrender.com/users/${userId}/vehicles`);
                    if (!response.ok) throw new Error("Error al obtener los vehículos.");

                    const vehicles = await response.json();
                    console.log("Vehículos cargados:", vehicles); // Verifica que los vehículos se cargan correctamente

                    const vehicleSelect = document.getElementById("vehicleSelect");
                    vehicleSelect.innerHTML = `<option value="" disabled selected>Selecciona un vehículo</option>`;

                    // Almacenar el ID del primer vehículo en localStorage si hay vehículos
                    if (vehicles.length > 0) {
                        localStorage.setItem("vehicleId", vehicles[0].vehicleId); // Almacena el ID del primer vehículo
                    }

                    vehicles.forEach(vehicle => {
                        const option = document.createElement("option");
                        option.value = vehicle.vehicleId; // Cambia vehicle.id a vehicle.vehicleId
                        option.textContent = `${vehicle.make} ${vehicle.model} (${vehicle.year})`; 
                        vehicleSelect.appendChild(option);
                        console.log(`Opción añadida: ${vehicle.vehicleId} - ${vehicle.make} ${vehicle.model}`); // Verifica que las opciones se añaden
                    });

                    vehicleSelect.addEventListener("change", () => {
                        console.log("Evento de cambio detectado en el select.");
                        const vehicleId = vehicleSelect.value;
                        console.log(`Vehicle ID seleccionado: ${vehicleId}`);
                        localStorage.setItem("vehicleId", vehicleId); // Almacena el ID del vehículo seleccionado
                    });
                } catch (error) {
                    console.error("Error al cargar los vehículos:", error.message);
                    alert("No se pudieron cargar los vehículos. Intenta más tarde.");
                }
            }

            loadVehicles();
        });

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("serviceForm").addEventListener("submit", async (event) => {
                event.preventDefault();
        
                const formData = new FormData();
                const userId = localStorage.getItem("userid");
                if (!userId) {
                    alert("Error: No se encontró el User ID. Por favor, inicia sesión.");
                    return;
                }
        
                const vehicleSelect = document.getElementById("vehicleSelect");
                const vehicleId = vehicleSelect.value;
                console.log("Vehicle ID al enviar el formulario:", vehicleId);
                if (!vehicleId) {
                    alert("Error: Debes seleccionar un vehículo.");
                    return;
                }
        
                const serviceDateInput = document.getElementById("serviceDate");
                if (!serviceDateInput) {
                    alert("Error: El campo de fecha del servicio no se encontró.");
                    return;
                }
                const serviceDate = serviceDateInput.value.trim();
                console.log("Valor de serviceDate:", serviceDate); // Verifica el valor de serviceDate
        
                if (!serviceDate) {
                    alert("Error: Debes ingresar una fecha.");
                    return;
                }
        
                const datePattern = /^(20[0-9]{2})-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/;
                if (!datePattern.test(serviceDate)) {
                    alert("Error: La fecha debe estar en el formato AAAA-MM-DD (por ejemplo, 2024-10-09).");
                    return;
                }
        
                const serviceTypeInput = document.getElementById("serviceType");
                if (!serviceTypeInput) {
                    alert("Error: El campo de tipo de servicio no se encontró.");
                    return;
                }
                const serviceType = serviceTypeInput.value.trim();
        
                const mileageInput = document.getElementById("mileageForService");
                if (!mileageInput) {
                    alert("Error: El campo de millas para el servicio no se encontró.");
                    return;
                }
                const mileageAtService = mileageInput.value.trim();
        
                const costInput = document.getElementById("cost");
                if (!costInput) {
                    alert("Error: El campo de costo no se encontró.");
                    return;
                }
                const cost = costInput.value.trim();
        
                const serviceCenterInput = document.getElementById("serviceCenter");
                if (!serviceCenterInput) {
                    alert("Error: El campo de centro de servicio no se encontró.");
                    return;
                }
                const serviceCenter = serviceCenterInput.value.trim();
        
                const notesInput = document.getElementById("notes");
                if (!notesInput) {
                    alert("Error: El campo de notas no se encontró.");
                    return;
                }
                const notes = notesInput.value.trim();
        
                if (!serviceType || !mileageAtService || !cost || !serviceCenter || !notes) {
                    alert("Error: Todos los campos son obligatorios.");
                    return;
                }
        
                formData.set("serviceDate", serviceDate);
                formData.set("serviceType", serviceType);
                formData.set("mileageAtService", mileageAtService);
                formData.set("cost", cost);
                formData.set("serviceCenter", serviceCenter);
                formData.set("notes", notes);
        
                // Verifica los valores en form

                // Verifica los valores en formData antes de enviar
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }

                const endpoint = `https://backend-autoplus.onrender.com/users/${userId}/vehicles/${vehicleId}/serviceHistory`;

                try {
                    const response = await fetch(endpoint, {
                        method: "POST",
                        body: formData,
                    });

                    if (response.ok) {
                        alert("Servicio agregado");
                        window.location.href = "index.html";
                    } else {
                        const result = await response.json();
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    alert(`Error de red: ${error.message}`);
                }
            });
        });
    </script>
</head>
<body>
    <header>
        <div class="nav-buttons">
            <button onclick="princi()" style="all: unset; cursor: pointer;">
                <span>Inicio</span>
            </button>
        </div>
        <i class="fa-solid fa-question-circle" onclick="preguntar()"></i>
    </header>
    
    <div class="divAgregar">
        <p id="userIdDisplay" style="margin-bottom: 20px; font-weight: bold;">User   ID: </p>
    
        <form id="serviceForm">
            <div class="info" id="vehiculo">
                <select class="input" id="vehicleSelect" name="vehicleSelect" required>
                    <option value="" disabled selected>Selecciona un vehículo</option>
                </select>
                <label class="label">Vehículo</label>
            </div>
            
            <div class="info" id="costo">
                <input type="number" step="0.01" class="input" id="cost" name="cost" required autocomplete="off">
                <label class="label">Costo</label>
            </div>
    
            <div class="info" id="millas">
                <input type="number" class="input" id="mileageForService" name="mileageForService" required autocomplete="off">
                <label class="label">Millas para el servicio</label>
            </div>
    
            <div class="info" id="notas">
                <textarea class="input textarea" id="notes" name="notes" rows="3" required></textarea>
                <label class="label" for="notes">Notas</label>
            </div>
    
            <div class="info" id="centroServicio">
                <input type="text" class="input" id="serviceCenter" name="serviceCenter" required autocomplete="off">
                <label class="label">Centro de servicio</label>
            </div>
    
            <div class="info" id="fecha">
                <input type="text" class="input" id="serviceDate" name="serviceDate" required autocomplete="off" placeholder="AAAA-MM-DD">
                <label class="label">Fecha del servicio</label>
            </div>
            
            <div class="info" id="tipoServicio">
                <input type="text" class="input" id="serviceType" name="serviceType" required autocomplete="off">
                <label class="label">Tipo de servicio</label>
            </div>
    
            <button type="submit" class="btn">Guardar Servicio</button>
        </form>
    </div>
    
    <nav style="position: fixed; bottom: 0; width: 100%; background-color: white; text-align: center;">
        <i class="fa-solid fa-house casita" onclick="princi()"></i>
        <i class="fa-solid fa-bell" onclick="verNotificaciones()"></i>
        <i class="fa-solid fa-location-dot" onclick="ubicar()"></i>
        <i class="fa-solid fa-gears config" onclick="registrar()"></i>
        <i ```html
class="fa-solid fa-right-from-bracket" onclick="cerrarSesion()" title="Cerrar sesión"></i>
        <i class="fa-solid fa-wrench" onclick="agregarServicio()" title="Agregar Servicio"></i>
    </nav>

    <p id="response"></p>

</body>
</html>
<script src="script.js"></script>
<script src="https://kit.fontawesome.com/dad89e78ab.js" crossorigin="anonymous"></script>